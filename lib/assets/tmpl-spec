var assert = require('assert');
var dropRequireCache = require('enb/lib/fs/drop-require-cache');
var HtmlDiffer = require('html-differ').HtmlDiffer;
var htmlDiffer = new HtmlDiffer({ bem: true });
<% _.forEach(engines, function(engine) {
%>var ${ engine.name } = require('${ engine.path }')${ engine.exportName };
<%
}); %>var referencesFilename = require.resolve('${ referencesFilename }');
var references;

describe('${ describe }', function() {
    beforeEach(function () {
        dropRequireCache(require, referencesFilename);
        references = require(referencesFilename);
    });
    <% _.forEach(its, function(it) {
       _.forEach(engines, function(engine) {

    %>
    it('should be equal `${ it }` by ${ engine.name }', function () {
        var bemjson = references['${ it }'].bemjson;
        var expectedHtml = references['${ it }'].html;
        var actualHtml = ${ engine.name }.apply(bemjson);

        assertHtml(expectedHtml, actualHtml);
    });
    <%

    });
    }); %>
});

function assertHtml(expectedHtml, actualHtml) {
    htmlDiffer.isEqual(expectedHtml, actualHtml) ?
        assert.ok(expectedHtml) :
        assert.fail(actualHtml, expectedHtml, null, '\n');
}
